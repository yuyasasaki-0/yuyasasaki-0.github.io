"use strict";
(function () {
  var globalObj = typeof globalThis !== "undefined" ? globalThis : typeof window !== "undefined" ? window : null;
  if (globalObj) {
    if (globalObj.__mailcheckerMessageOnSentV1) return;
    globalObj.__mailcheckerMessageOnSentV1 = true;
  }

  function lower(text) {
    return text == null ? "" : String(text).toLowerCase();
  }

  function domainFromAddress(address) {
    if (!address) return "";
    var value = String(address).trim();
    var at = value.lastIndexOf("@");
    if (at < 0) return "";
    return lower(value.slice(at + 1));
  }

  function displayLang() {
    try {
      return (Office.context && Office.context.displayLanguage) || "en-US";
    } catch (_e) {
      return "en-US";
    }
  }

  function decodeBase64(value) {
    try {
      if (typeof atob === "function") return atob(value);
    } catch (_e) {}
    return "";
  }

  function internalDomainConfig() {
    var exact = {};
    var contains = [];

    try {
      var sender =
        Office.context &&
        Office.context.mailbox &&
        Office.context.mailbox.userProfile &&
        Office.context.mailbox.userProfile.emailAddress
          ? Office.context.mailbox.userProfile.emailAddress
          : "";
      var senderDomain = domainFromAddress(sender);
      if (senderDomain) exact[senderDomain] = true;
    } catch (_e) {}

    try {
      if (typeof iv7ym8223nqw !== "string" || !iv7ym8223nqw) return { exact: exact, contains: contains };
      var decoded = decodeBase64(iv7ym8223nqw);
      if (!decoded) return { exact: exact, contains: contains };
      var data = JSON.parse(decoded);
      var domains = data && data.domains ? data.domains : {};
      var exactList = Array.isArray(domains.em) ? domains.em : [];
      var containsList = Array.isArray(domains.bm) ? domains.bm : [];

      for (var i = 0; i < exactList.length; i++) {
        var d = lower(exactList[i]).trim();
        if (d) exact[d] = true;
      }

      for (var j = 0; j < containsList.length; j++) {
        var p = lower(containsList[j]).trim();
        if (p) contains.push(p);
      }
    } catch (_e) {}

    return { exact: exact, contains: contains };
  }

  function isInternalDomain(domain, cfg) {
    if (!domain) return false;
    var d = lower(domain);
    if (cfg && cfg.exact && cfg.exact[d]) return true;
    if (cfg && Array.isArray(cfg.contains)) {
      for (var i = 0; i < cfg.contains.length; i++) {
        var part = cfg.contains[i];
        if (part && d.indexOf(part) !== -1) return true;
      }
    }
    return false;
  }

  function safeGet(listObj, cb) {
    try {
      if (!listObj || typeof listObj.getAsync !== "function") return cb([]);
      listObj.getAsync(function (res) {
        try {
          if (res && res.status === Office.AsyncResultStatus.Succeeded && Array.isArray(res.value)) {
            return cb(res.value);
          }
        } catch (_e2) {}
        return cb([]);
      });
    } catch (_e) {
      return cb([]);
    }
  }

  function isDistributionList(recipient) {
    var t = recipient ? recipient.recipientType : null;
    if (t === "distributionList") return true;
    try {
      return (
        Office.MailboxEnums &&
        Office.MailboxEnums.RecipientType &&
        t === Office.MailboxEnums.RecipientType.DistributionList
      );
    } catch (_e) {
      return false;
    }
  }

  function evaluateRecipients(recipients, cfg) {
    var externalDomains = {};
    var externalList = [];
    var externalCount = 0;
    var dlCount = 0;

    var list = recipients || [];
    for (var i = 0; i < list.length; i++) {
      var r = list[i] || {};
      if (isDistributionList(r)) dlCount++;

      var addr = r.emailAddress || r.address || "";
      var dom = domainFromAddress(addr);
      if (!dom) continue;
      if (isInternalDomain(dom, cfg)) continue;

      externalCount++;
      if (!externalDomains[dom]) {
        externalDomains[dom] = true;
        externalList.push(dom);
      }
    }

    externalList.sort();
    return { externalCount: externalCount, dlCount: dlCount, domains: externalList };
  }

  function shouldSkipIfAllInternal(isAppointment) {
    try {
      if (isAppointment) return !!isSkipConfirmationIfAllRecipientsAreInternalOnAppointment;
      return !!isSkipConfirmationIfAllRecipientsAreInternalOnMail;
    } catch (_e) {
      return false;
    }
  }

  function buildMessage(lang, stats) {
    var list = stats.domains.slice(0, 5);
    var suffix = stats.domains.length > 5 ? ", ..." : "";
    var domainText = list.length ? list.join(", ") + suffix : "";

    if (lang === "ja-JP") {
      if (domainText) {
        return (
          "外部宛先を検出しました (" +
          domainText +
          "). " +
          "「Send anyway」で送信します。"
        );
      }
      return "送信前確認: 「Send anyway」で送信します。";
    }

    if (domainText) {
      return 'External recipients detected (' + domainText + '). Choose "Send anyway" to send.';
    }
    return 'Confirm before sending. Choose "Send anyway" to send.';
  }

  function finalizeOnce(event) {
    var finished = false;
    return {
      allow: function () {
        if (finished) return;
        finished = true;
        try {
          event.completed({ allowEvent: true });
        } catch (_e) {}
      },
      block: function (message) {
        if (finished) return;
        finished = true;
        try {
          event.completed({ allowEvent: false, errorMessage: message });
        } catch (_e) {
          try {
            event.completed({ allowEvent: false });
          } catch (_e2) {}
        }
      },
    };
  }

  function messageOnSent(event) {
    if (!event || typeof event.completed !== "function") return;

    var done = finalizeOnce(event);
    var timeoutId = null;

    try {
      timeoutId = setTimeout(function () {
        done.allow();
      }, 4500);
    } catch (_e) {}

    try {
      var item = Office.context && Office.context.mailbox ? Office.context.mailbox.item : null;
      if (!item) return done.allow();

      var lang = displayLang();
      var cfg = internalDomainConfig();

      var typeAppointment = null;
      try {
        typeAppointment = Office.MailboxEnums.ItemType.Appointment;
      } catch (_e2) {}
      var isAppointment =
        (typeAppointment != null && item.itemType === typeAppointment) || item.itemType === "appointment";

      var skipInternal = shouldSkipIfAllInternal(isAppointment);

      var finish = function (stats) {
        try {
          if (timeoutId != null) clearTimeout(timeoutId);
        } catch (_e3) {}
        if (skipInternal && stats.externalCount === 0 && stats.dlCount === 0) return done.allow();
        return done.block(buildMessage(lang, stats));
      };

      if (isAppointment) {
        safeGet(item.requiredAttendees, function (required) {
          safeGet(item.optionalAttendees, function (optional) {
            var all = (required || []).concat(optional || []);
            finish(evaluateRecipients(all, cfg));
          });
        });
        return;
      }

      safeGet(item.to, function (toList) {
        safeGet(item.cc, function (ccList) {
          safeGet(item.bcc, function (bccList) {
            var all = (toList || []).concat(ccList || []).concat(bccList || []);
            finish(evaluateRecipients(all, cfg));
          });
        });
      });
    } catch (_e) {
      try {
        if (timeoutId != null) clearTimeout(timeoutId);
      } catch (_e4) {}
      return done.allow();
    }
  }

  function registerHandlers() {
    try {
      if (typeof Office === "undefined") return;
      if (Office.actions && typeof Office.actions.associate === "function") {
        Office.actions.associate("messageOnSent", messageOnSent);
      }
    } catch (_e) {}
  }

  try {
    if (typeof Office !== "undefined" && Office.onReady && typeof Office.onReady === "function") {
      Office.onReady(registerHandlers);
    } else {
      registerHandlers();
    }
  } catch (_e) {
    registerHandlers();
  }
})();
